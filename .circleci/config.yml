version: 2.1

# ===================================================================
# 1. JOB PARA GENERAR EL .ALF
# ===================================================================
jobs:
  generate-alf:
    docker:
      - image: unityci/editor:ubuntu-6000.0.62f1-webgl-3.2.0
    resource_class: large
    steps:
      - checkout
      - run:
          name: Generar archivo de activación (.alf)
          command: |
            xvfb-run --auto-servernum --server-args='-screen 0 640x480x24' \
              /opt/unity/Editor/Unity \
              -batchmode -nographics -quit \
              -projectPath . \
              -createManualActivationFile \
              -logFile /dev/stdout
      - store_artifacts:
          path: ~/project
          destination: alf-file   # aquí aparecerá el archivo .alf

  # ===================================================================
  # 2. JOB NORMAL DE BUILD
  # ===================================================================
  build-webgl:
    docker:
      - image: unityci/editor:ubuntu-6000.0.62f1-webgl-3.2.0
    resource_class: large
    working_directory: ~/project

    steps:
      - checkout

      # Activar licencia Personal
      - run:
          name: Activar licencia Unity Personal (CI-compatible)
          command: |
            echo "$UNITY_ENCODED_LICENSE" | base64 -d > /tmp/unity.ulf
            xvfb-run --auto-servernum --server-args='-screen 0 640x480x24' \
              /opt/unity/Editor/Unity \
              -batchmode -nographics -quit -logFile /dev/stdout \
              -manualLicenseFile /tmp/unity.ulf

      # Build WebGL
      - run:
          name: Build WebGL
          command: |
            mkdir -p Build/WebGL
            xvfb-run --auto-servernum --server-args='-screen 0 640x480x24' \
              /opt/unity/Editor/Unity \
              -batchmode -nographics -silent-crashes -quit \
              -projectPath . \
              -executeMethod BuildWebGL.PerformBuild \
              -logFile /dev/stdout

      # Guardar artefacto
      - store_artifacts:
          path: Build/WebGL
          destination: WebGL_Build

# ===================================================================
# WORKFLOWS
# ===================================================================
workflows:
  version: 2

  # Descomenta esta línea cuando necesites generar el .alf (solo la primera vez)
  generate-license:
    jobs:
      - generate-alf

  # Esta es la que tendrás siempre activa
  # build-and-deploy:
  #   jobs:
  #     - build-webgl
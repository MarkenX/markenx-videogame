version: 2.1

jobs:
  build_webgl:
    docker:
      - image: cimg/base:stable
    working_directory: ~/project
    steps:
      - checkout

      # Configurar Docker remoto para builds de Unity
      - setup_remote_docker:
          docker_layer_caching: true

      # Restaurar caché de Docker
      - restore_cache:
          keys:
            - docker-layer-cache-{{ checksum "ci/Dockerfile.unity-webgl" }}
            - docker-layer-cache-

      # Construir la imagen Docker con Unity + WebGL
      - run:
          name: Build Docker container
          command: |
            docker build -f ci/Dockerfile.unity-webgl -t unity-webgl .

      # Guardar la capa de Docker en caché
      - save_cache:
          key: docker-layer-cache-{{ checksum "ci/Dockerfile.unity-webgl" }}
          paths:
            - /var/lib/docker

      # Ejecutar el build dentro del contenedor
      - run:
          name: Run Unity WebGL Build
          command: |
            docker run --rm -v ~/project:/root/project -v ~/project/Build:/root/build unity-webgl

      # Guardar el build como artefacto
      - store_artifacts:
          path: Build/WebGL
          destination: WebGL_Build

workflows:
  version: 2
  build_and_store:
    jobs:
      - build_webgl